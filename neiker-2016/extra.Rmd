---
title: 'Case studies'
author: "Dae-Jin Lee"
date: "<http://idaejin.github.io/bcam-courses>"
output:
  slidy_presentation:
    fig_caption: yes
    highlight: haddock
    keep_md: yes
  ioslides_presentation:
    highlight: kate
    incremental: no
subtitle: Basque Center for Applied Mathematics
---


---------------------------------------


# Variability in Semiconductor Manufacturing

These data comes *from a passive data collection study in the semiconductor industry where the objective is to estimate the variance components to determine the assignable causes of the observed variability*. The observed response is the thickness of the oxide layer on silicon wafers, measured at three different sites of each of three wafers selected from each of eight lots sampled from the population of lots.

```{r,fig.cap="*Thickness of Oxide layer measured on different sites of wafers selected from a sample of manufacturing lots.*"}
library(nlme)
library(lattice)
data(Oxide)
?Oxide
xyplot(Lot~Thickness,group=Wafer,auto.key=TRUE,pch=Oxide$Site,data=Oxide)
xtabs(~ Lot + Wafer, Oxide)
```

The Figure suggests that tht *lot-to-lot* variability of the oxide layer thickness is greater than the *wafer-to-wafer* variability within a lot, which, in turn, is greater than the *site-to-site* variation within a wafer.

A multilevel model to describe the oxide thickness $y_{ijk}$ measured on the $k$th site of the $j$th wafer within the $i$th lot is
$$
      y_{ijk}  = \mu + b_i + b_{i,j} + \epsilon_{ijk}, ~ i=1,...,8 \quad j,k = 1,2,3  
$$
with 
$$
      b_i \sim \mathcal{N}(0,\sigma_1^2), \quad b_{i,j} \sim \mathcal{N}(0,\sigma_2^2), \quad \epsilon_{ijk} \sim \mathcal{N}(0,\sigma^2),
$$
where `lot` random effects $b_i$ are assumed to be independent for different $i$, the *wafer within lot* random effects $b_{i,j}$ are assumed to be independent for different $i$ and $j$ and to be independent of the $b_i$, and the *within-group* errors $\epsilon_{ijk}$ are assumed to be independent for different $i,j,$ and $k$ and to be independent of the random effects. 

The most general form of the argument `random` when `lme` is used to fit a multilevel model is a *named list* where the names define the grouping factors and the formulas describe the random-effects models at each level. The order of nesting is taken to be the order of the elements in the list, with the outermost level appearing first. 

```{r,eval=FALSE}
random = list(Lot= ~1, Wafer = ~1)
```

When the random-effects formulas are the same for all levels of grouping, we can replace the named list by a one-sided formula with the common random-effects formula and an expression defining the grouping structure separated by a `|` operation 

```{r,eval=FALSE}
random = list(~1|Lot/Wafer)
```

```{r}
formula(Oxide) # grouping formula already defined
```


```{r}
fm1Oxide <- lme(Thickness~1,Oxide) 
# or lme(Thickness~1,random=list(Lot= ~1, Wafer = ~1),Oxide)
# or lme(Thickness~1,random= ~1|Lot/Wafer,Oxide)
fm1Oxide
```

```{r}
intervals(fm1Oxide,which="var-cov")
```

All intervals are bounded well away from zero, indicating that the two random effects should be kept. We can test, for example, if the *wafer within lot* random effect can be eliminated from the model with 

```{r}
fm2Oxide <- update(fm1Oxide, random = ~1|Lot)
anova(fm1Oxide,fm2Oxide)
```
The very high value of the LR test confirms the significance of that term in the model. 


```{r,echo=FALSE,eval=FALSE}
coef(fm1Oxide,level=1) # Estimated average oxide layer thickness by lot
coef(fm1Oxide,level=2) # Estimated average oxide layer thickness per Wafer
```

```{r,echo=FALSE,eval=FALSE}
ranef(fm1Oxide,level=1:2) 
```


```{r,echo=FALSE,eval=FALSE}
fm3Oxide <- lme(Thickness~Site+Source,Oxide,random=~1|Lot/Wafer)
plot(fm3Oxide) # check resids vs fitted values
qqnorm(residuals(fm3Oxide)) # check resids for normality
abline(0,sd(resid(fm3Oxide)))
qqnorm(fm3Oxide,~ranef(.,level=1))
qqnorm(fm3Oxide,~ranef(.,level=2))
fm4Oxide <- lme(Thickness~Site+Source,Oxide,random=~1|Lot)
anova(fm3Oxide,fm4Oxide) # Reject H0
anova(fm3Oxide) # no evidence of Site or Source Effects
intervals(fm3Oxide)
```


# Titanic survivors data

The dataset is a collection of data about some of the passengers, and the goal is to predict the survival (either 1 if the passenger survived or 0 if they did not) based on some features such as the class of service, the sex, the age etc. As you can see, we are going to use both categorical and continuous variables.

```
VARIABLE DESCRIPTIONS:
pclass          Passenger Class
                (1 = 1st; 2 = 2nd; 3 = 3rd)
survival        Survival
                (0 = No; 1 = Yes)
name            Name
sex             Sex
age             Age
sibsp           Number of Siblings/Spouses Aboard
parch           Number of Parents/Children Aboard
ticket          Ticket Number
fare            Passenger Fare
cabin           Cabin
embarked        Port of Embarkation
                (C = Cherbourg; Q = Queenstown; S = Southampton)
boat            Lifeboat
body            Body Identification Number
home_dest       Home/Destination
```
Full description of [data set](http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/titanic3info.txt)

```{r,echo=FALSE,message=FALSE,warning=FALSE}
# http://datascienceplus.com/perform-logistic-regression-in-r/
training.data.raw <- read.csv('extra-data/train.csv',header=TRUE,na.strings=c(""))

# sapply(training.data.raw,function(x) sum(is.na(x)))
# sapply(training.data.raw, function(x) length(unique(x)))

data <- subset(training.data.raw,select=c(2,3,5,6,7,8,10,12))

data$Age[is.na(data$Age)] <- mean(data$Age,na.rm=T)
#is.factor(data$Sex)
#is.factor(data$Embarked)

data <- data[!is.na(data$Embarked),]
rownames(data) <- NULL

train <- data[1:800,]
test <- data[801:889,]

write.csv(train,"extra-data/titanic_train.csv")
write.csv(train,"extra-data/titanic_test.csv")
```


Read `train` and `test` set
```{r}
train <- read.csv('extra-data/titanic_train.csv',header=TRUE,row.names=1)
 test <- read.csv('extra-data/titanic_test.csv',header=TRUE,row.names=1)
```

## Questions

* Fit a logistic model with `pclass` as exploratory variable. What is the interpretation of the fitted model?
* Find the best possible logistic regression model based on all the available variables.


--------------------------

# Minnesota Health Plan Dataset 

Number of clinic visits and calls to clinic for 4 nonoverlapping six month periods for each of 121 senior citizens enrolled in a medical plan. From:

*Waller LA, Zelterman D (1979). Log-Linear Modeling with the Negative Multinomial Distribution Biometrics 53(3): 971-982*


```{r}
source("extra-data/mhp.r")

head(mhp)


library(lme4)
mod <- glmer(Count ~ Event*Period + (1|Subject) + (1|Subject:Event) + (1|Subject:Period), data=mhp,
family=poisson(log))

```


# Productivity Scores for Machines and Workers


Data on an experiment to compare three brands of machines used in an industrial process are presented in @Milliken92. Six workers were chosen randomly among the employees of a factory to operate each machine three times. The response is an overall productivity score taking into account the number and quality of components produced.

```{r}
library(nlme)
data(Machines)
head(Machines)
?Machines
```

The next Figure shows that there are differences between machines and also some differences between workers. There is also very little variability in the productivity score for the same worker using the same machine. 

```{r,fig.cap="*Productivity scores for three types of machines as used by six different workers. Scores take into account the number and the quality of components produced.*",fig.width=12}
plot(Machines)
```

We can model the `Worker` factor as a random effect and `Machine` as fixed. 

```{r,echo=FALSE}
attach(Machines)
interaction.plot(Machine,Worker,score,las=1,lwd=1.4,col=1:6)
detach()
```

First, we consider a model 
$$
    y_{ijk} = \mu_j + b_i + \epsilon_{ijk}, \quad i=1,...,6
,\quad j=1,...,3,\quad k=1,...,3,
$$
with $b_i \sim \mathcal{N}(0,\sigma^2_b)$, $\epsilon_{ijk}\sim\mathcal{N}(0,\sigma^2)$.

```{r}
fm1Machine <- lme(score ~ Machine, data=Machines,random= ~1|Worker)
fm1Machine
```

We can consider a random interaction term, by $b_{ij}$, $i=1,...,6$, $j=1,...,3$, is
$$
    y_{ijk} = \mu_j + b_i + b_{ij} + \epsilon_{ijk}, \quad i=1,...,6
,\quad j=1,...,3,\quad k=1,...,3,
$$
with $b_i \sim \mathcal{N}(0,\sigma_1^2)$, $b_{ij} \sim \mathcal{N}(0,\sigma_2^2)$, $\epsilon_{ijk}\sim\mathcal{N}(0,\sigma^2)$.

This model has random effects at two levels: 

* the effects $b_i$ for the worker and
* the effects $b_{ij}$ for the type of machine within each worker. 

```{r}
fm2Machine <- update(fm1Machine,random= ~1|Worker/Machine)
fm2Machine
```

Here the random effect structure is read as `Worker` and `Machine` within `Worker`.

```{r}
anova(fm1Machine,fm2Machine)
```
Reject $H_0:\sigma_2^2 = 0$ 

```{r}
intervals(fm2Machine)
```





# Alligator data

Data from a study of the primary food choices of alligators in four Florida lakes. Researchers classified the stomach contents of 219 captured alligators into five categories: Fish (the most common primary food choice), Invertebrate (snails, insects, crayfish, etc.), Reptile (turtles, alligators), Bird, and Other (amphibians, plants, household pets, stones, and other debris).


```{r}
alligator <- read.table("http://www.hofroe.net/stat557/data/alligator.txt", header=TRUE)

summary(alligator)

# make the fish the first variable
alligator$food <- factor(alligator$food, levels=levels(alligator$food)[c(2,1,3,4,5)])

```

```{r}
library(nnet)
alli.main <- multinom(food~lake+size+gender, data=alligator)
alli.main


summary(alli.main)

alli.full <- multinom(food~size*gender*lake, data=alligator)

alli.twoway <- multinom(food~size*gender*lake-size:gender:lake, data=alligator)


alli.null <- multinom(food~1, data=alligator)

deviance(alli.full)
deviance(alli.twoway)
deviance(alli.main)
deviance(alli.null)

# test each individual main effect
alli.g <- multinom(food~gender, data=alligator)

alli.s <- multinom(food~size, data=alligator)

alli.l <- multinom(food~lake, data=alligator)

# gender does not seem to be significant
anova(alli.null,alli.g)
# size and lake are significant
anova(alli.null,alli.s)
anova(alli.null,alli.l)

# interaction between size and lake does not seem necessary
alli.sl <- multinom(food~size*lake, data=alligator)
alli.s.l <- multinom(food~size+lake, data=alligator)
anova(alli.s.l, alli.sl)
anova(alli.null,alli.s.l)
anova(alli.null,alli.s.l)



```

Zuur et al. (2007) used marine benthic data from nine inter-tidal areas along the Dutch coast. The data were collected by the Dutch institute RIKZ in the summer of 2002. In each inter-tidal area (denoted by ‘beach’), five samples were taken, and the macro-fauna and abiotic variables were measured. Zuur et al. (2007) used species richness (the number of different species) and NAP (the height of a sampling station compared to mean tidal level) from these data to illustrate statistical methods like linear regression and mixed effects modelling. 


# Owls data

Analysis of owl nestling begging data from Zuur et al 2009/Roulin and Bersier 2007.


```{r}

Owls <- read.table("extra-data/Owls.txt",header=TRUE)


library(lattice)
print(bwplot(reorder(Nest,NegPerChick)~NegPerChick|FoodTreatment:SexParent,
       data=Owls))

print(dotplot(reorder(Nest,NegPerChick)~NegPerChick|FoodTreatment:SexParent,
       data=Owls))

```

```{r}
g1 <- glmer(SiblingNegotiation~FoodTreatment*SexParent+offset(log(BroodSize))+
            (1|Nest),family=poisson,data=Owls)
print(summary(g1))

```



